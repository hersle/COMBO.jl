%\documentclass[onecolumn]{aa} % for a paper on 1 column  
%\documentclass[longauth]{aa} % for the long lists of affiliations
%\documentclass[bibyear]{aa} % if the references are not structured according to the author-year natbib style
%\documentclass{aa}  
%\documentclass{memoir}
%\documentclass[oldfontcommands]{memoir}
%\documentclass[twocolumn]{revtex4-2}
%\documentclass[12pt,a4paper,oldfontcommands]{memoir}
\documentclass[10pt,a4paper]{article}
%\documentclass[10pt,a4paper,onecolumn]{paper}
\usepackage{fullpage}

\usepackage{amsmath}
\usepackage{amssymb}
\usepackage{graphicx}
%\usepackage{txfonts}
\usepackage[linktocpage=true, colorlinks=true, allcolors=blue]{hyperref}
\usepackage[labelfont=bf]{caption}
\usepackage[noabbrev]{cleveref}
\usepackage{tensor}
\usepackage{derivative}
\usepackage{booktabs}
\usepackage{mathtools}
\usepackage[export]{adjustbox}

\usepackage{biblatex}
%\bibliographystyle{plainnat}
\addbibresource{report.bib}

\newcommand\TODO[1]{\textcolor{red}{(\textbf{TODO:} #1)}}
\DeclareMathOperator{\asin}{asin}
\DeclareMathOperator{\sinc}{sinc}
\DeclareMathOperator{\diag}{diag}
\DeclareMathOperator{\argmax}{argmax}
%\setlength{\mathindent}{20pt}

\begin{document}

\title{\textbf{Solving the Einstein-Boltzmann equations}\\ \\\normalsize\textit{(AST5220 project report)}}
%\subtitle{Einstein-Boltzmann solver}
\author{Herman Sletmoen}

%\institute{ITA Oslo}
\date{Spring 2023}

\iffalse
\abstract
% context heading (optional)
{Solve Einstein-Boltzmann equations}
% aims heading (mandatory)
{Solve Einstein-Boltzmann equations}
% methods heading (mandatory)
{Solve Einstein-Boltzmann equations}
% results heading (mandatory)
{Solve Einstein-Boltzmann equations}
% conclusions heading (optional)
{Solve Einstein-Boltzmann equations}
\fi

%\keywords{cosmology -- Einstein-Boltzmann equations}

\maketitle
%
%________________________________________________________________

%\tableofcontents

\textbf{Code:} All code is available at \href{https://github.com/hersle/AST5220-project}{github.com/hersle/AST5220-project}.

\section{Introduction}

\TODO{WIP for now, eventually weave this together with the remaining milestones}

Einstein field equations:
\begin{equation}
	G\indices{_\mu_\nu} + \Lambda g\indices{_\mu_\nu} = \frac{8 \pi G}{c^4} T\indices{_\mu_\nu},
\label{eq_einstein}
\end{equation}
where $\Lambda$ is the cosmological constant.
Energy-momentum tensor:
\begin{equation}
	T\indices{^\mu_\nu} = ...
\label{eq_energy_momentum}
\end{equation}

Except in \cref{sec_supernova}, where we look for constraints on cosmological parameters, we use the Planck's cosmological parameters from 2018 \cite{planckcollaborationPlanck2018Results2020},
given and related by:
\begin{equation}
\begin{aligned}
	& \text{reduced Hubble parameter} & h &= 0.67, \\
	& \text{Hubble parameter} & H_0 &= h \cdot \frac{100\,\mathrm{km}}{\mathrm{s}\,\mathrm{Mpc}} = 67 \frac{\mathrm{km}}{\mathrm{s}\,\mathrm{Mpc}}, \\
	& \text{photon temperature} & T_{\gamma0} &= 2.7255\,K, \\
	& \text{effective neutrino number} & N_\text{eff} &= 3.046, \\
	& \text{baryonic matter density parameter} & \Omega_{b0} &= 0.05, \\
	& \text{cold dark matter density parameter} & \Omega_{c0} &= 0.267,\\
	& \text{matter density parameter} & \Omega_{m0} &= \Omega_{b0} + \Omega_{c0} = 0.317, \\
	& \text{curvature density parameter} & \Omega_{k0} &= 0, \\
	& \text{photon density parameter} & \Omega_{\gamma0} &= \frac{\pi^2}{15} \cdot \frac{(k_B T_{\gamma0})^4}{\hbar^3 c^5} \cdot \frac{8 \pi G}{3 H_0^2} = 5.5 \cdot 10^{-5} , \\
	& \text{neutrino density parameter} & \Omega_{\nu0} &= N_{\rm eff}\cdot \frac{7}{8}\left(\frac{4}{11}\right)^{\frac43}\Omega_{\gamma 0} = 3.8 \cdot 10^{-5} , \\
	& \text{radiation density parameter} & \Omega_{r0} &= \Omega_{\gamma0} + \Omega_{\nu0} = 9.3 \cdot 10^{-5}, \\
	& \text{cosmological constant density parameter} & \Omega_{\Lambda 0} &= 1 - (\Omega_{k 0}+\Omega_{b 0}+\Omega_{c0}+\Omega_{\gamma 0}+\Omega_{\nu 0}) = 0.683,\\
	& \text{power spectrum spectral index} & n_s &= 0.965, \\
	& \text{power spectrum amplitude} & A_s &= 2.1\cdot 10^{-9}, \\
	& \text{primordial helium mass fraction} & Y_p &= 0.245, \\
	& \text{first reionization redshift} & z^{\rm reion}_1 &= 8.0, \\
	& \text{first reionization redshift duration} & \Delta z^{\rm reion}_1 &= 0.5, \\
	& \text{second reionization redshift} & z^{\rm reion}_2 &= 3.5, \\
	& \text{second reionization redshift duration} & \Delta z^{\rm reion}_2 &= 0.5.
\end{aligned}
\label{eq_planck2018}
\end{equation}


\clearpage

\section{Background cosmology}
\label{sec_background_cosmology}

According to the cosmological principle,
our Universe is spatially homogeneous and isotropic when averaged over large distances.
In this section, we will study the cosmology that describes such a universe
with radiation, matter, the cosmological constant and spatial curvature.
Formally, this is the zeroth-order ``background'' solution of the perturbed, inhomogeneous structured universe we aim to describe.

\subsection{Theory}
\label{sec_background_cosmology_theory}

\subsubsection{Friedmann equation}

The geometry of a \emph{spatially} homogeneous and isotropic universe
is described by the \textbf{Friedmann-Lemaître-Robertson-Walker (FLRW) metric}
\begin{equation}
\begin{split}
	ds^2 &= -c^2 dt^2 + a^2(t) \left[\frac{dr^2}{1 - kr^2} + r^2\left(d\theta^2 + \sin^2\theta \, d\phi^2\right) \right] \\
	     &= a^2(t) \left[-c^2 d\eta^2 + \frac{dr^2}{1 - kr^2} + r^2\left(d\theta^2 + \sin^2\theta \, d\phi^2\right) \right].
\end{split}
\label{eq_flrw}
\end{equation}
Here it is in spherical coordinates $(r,\theta,\phi)$, curvature $k$, scale factor $a(t)$,
and either cosmic time $t$ or conformal time $\eta$ defined by $d\eta = dt/a$\footnote{I prefer the convention in which conformal time is a time, while others like it to be the distance $d\eta \rightarrow c \, d\eta$.},
so it is conformal to the Minkowski metric in the flat case $k=0$.

The homogeneous background universe is filled with an ideal fluid that has a
time-dependent density $\rho(t)$, pressure $P(t)$ and thus energy-momentum tensor
\begin{equation}
	T\indices{^\mu_\nu} = \diag\Big[\rho(t),\, -P(t),\, -P(t),\, -P(t)\Big].
\label{eq_energy_momentum_homogeneous}
\end{equation}
The dynamics and evolution of the universe is governed by the Einstein field equations \eqref{eq_einstein},
with the FLRW metric \eqref{eq_flrw} on the left and energy-momentum tensor \eqref{eq_energy_momentum_homogeneous} on the right.
In addition to curvature and the cosmological constant,
we consider a universe with radiation and matter with densities $\rho_r$ and $\rho_m$,
and pressures given by their equations of state $P_m = 0$ and $P_r = \rho_r \, c^2 / 3$.
In particular, the $00$ and $11$-components give rise to the Friedmann equation for the Hubble parameter
\begin{equation}
	H(t) = \frac{1}{a} \odv{a}{t} = H_0 \sqrt{\Omega_{r0} \, a^{-4} + \Omega_{m0} \, a^{-3} + \Omega_{k0} \, a^{-2} + \Omega_{\Lambda0}},
\label{eq_friedmann}
\end{equation}
where radiation, matter, curvature and the cosmological constant have the (effective) mass densities
\begin{equation}
	\rho_r(t) = \rho_{r0} a^{-4}, \quad
	\rho_m(t) = \rho_{m0} a^{-3}, \quad
	\rho_k(t) = -\frac{3kc^2}{8 \pi G} a^{-2} = \rho_{k0} a^{-2}, \quad
	\rho_\Lambda(t) = \frac{\Lambda c^2}{8 \pi G} = \text{constant},
\end{equation}
and we define the time-dependent density parameters
\begin{equation}
	\Omega_s(t) = \frac{\rho_s(t)}{\rho_\text{crit}(t)}
\label{eq_density_parameters}
\end{equation}
relative to the critical density $\rho_\text{crit}(t) = 3H^2(t)/8\pi G$.
Present-day values are denoted by $F_0=F(t_0)$.

Due to the densities' differing dependencies on the scale factor,
a universe with all four species will be dominated by radiation early on, then matter, then curvature, and finally the cosmological constant.
We are mostly concerned with a flat universe where there is no curvature that can ever dominate,
so the scale factors at radiation-matter and matter-cosmological constant equality are found from
\begin{subequations}
\begin{align}
	\rho_r(t) &= \rho_m(t)       && \text{at} && a = a_\text{eq}^{rm} = \frac{\rho_{r0}}{\rho_{m0}} = \frac{\Omega_{r0}}{\Omega_{m0}}, \label{eq_equality_radiation_matter} \\
	\rho_m(t) &= \rho_\Lambda(t) && \text{at} && a = a_\text{eq}^{m\Lambda} = \left(\frac{\rho_{m0}}{\rho_{\Lambda}}\right)^\frac13 = \left(\frac{\Omega_{m0}}{\Omega_{\Lambda0}}\right)^\frac13. \label{eq_equality_matter_cosmological_constant}
\end{align}
\label{eq_equality_times}
\end{subequations}

Moreover, the acceleration of the scale factor
\begin{equation}
	\ddot{a} = \odv[2]{a}{t} = -a^2 H_0^2 \Big( 2 \, \Omega_{r0} a^{-4} + \Omega_{m0} a^{-3} - 2 \, \Omega_{\Lambda0} \Big).
\label{eq_acceleration}
\end{equation}
will be negative at early times as the expansion slows down,
but the expansion starts to accelerate as the cosmological constant takes over.

In addition to the ``cosmic'' Hubble parameter \eqref{eq_friedmann},
we define the \textbf{conformal Hubble parameter}
\begin{equation}
	\mathcal{H} = \frac1a \odv{a}{\eta} = \odv{a}{t} = a H.
\label{eq_conformal_hubble}
\end{equation}
For example, in universes dominated by radiation, matter and the cosmological constant,
we have,
\begin{subequations}
\begin{align}
	\mathcal{H} &= H_0 \sqrt{\Omega_{r0}} \, a^{-1} && \Big( \Omega_r \gg \{\Omega_m,\Omega_\Lambda\} \Big), \label{eq_conformal_hubble_dominated_radiation} \\
	\mathcal{H} &= H_0 \sqrt{\Omega_{m0}} \, a^{-1/2} && \Big( \Omega_m \gg \{\Omega_r,\Omega_\Lambda\} \Big), \\
	\mathcal{H} &= H_0 \sqrt{\Omega_{\Lambda0}} \, a && \Big( \Omega_\Lambda \gg \{\Omega_m,\Omega_r\} \Big).
\end{align}
\label{eq_conformal_hubble_dominated}
\end{subequations}

\subsubsection{Cosmic and conformal time}

In the form \eqref{eq_friedmann},
the Friedmann equation is a differential equation for the scale factor $a(t)$
as a function of the cosmic time $t$.
We will ``exchange'' $a(t) \leftrightarrow t(a)$, and instead parametrize the evolution of the universe with (the natural logarithm of) the scale factor $x = \log a$.
\textbf{This requires that $a(t)$ is monotonically increasing, so it is one-to-one with $t$!}
This \emph{always} holds in a universe with $\Omega_{k} \geq 0$,
but \textbf{breaks for some $\Omega_{k} < 0$, where the universe can have a turnaround $\dot{a} = 0$}.
We will always consider a flat universe and be fine,
except in \cref{sec_supernova} where we make a small detour and allow for nonzero curvature.

Parametrizing with $a$ or $x$, we can solve $H = \frac1a \odv{a}{t}$ and $d\eta = dt / a$ for the cosmic and conformal times
\begin{equation}
	t(a) = \int_0^a \frac{da}{aH} = \int_0^x \frac{dx}{H}
	\qquad \text{and} \qquad
	\eta(a) = \int_0^a \frac{da}{a^2 H} = \int_0^x \frac{dx}{aH}.
\label{eq_cosmic_conformal_time}
\end{equation}
In general, these integrals must be computed numerically.
However, in a flat universe with no cosmological constant and radiation-matter equality \eqref{eq_equality_radiation_matter},
they can be evaluated analytically to give
\begin{subequations}
\begin{align}
	t(a) &= \int_0^a \frac{da}{H_0 \sqrt{\Omega_{r0}a^{-2} + \Omega_{m0}a^{-1}}}
	      = \frac{2}{3 H_0 \sqrt{\Omega_{m0}}} \Big[\sqrt{a + a_\text{eq}} \big(a - 2 a_\text{eq}\big) + 2 a_\text{eq}^\frac32 \Big] && \Big(\Omega_k=\Omega_\Lambda=0\Big)
	\label{eq_cosmic_time_anal}, \\
	\eta(a) &= \int_0^a \frac{da}{H_0 \sqrt{\Omega_{r0} + \Omega_{m0} a}}
		     = \frac{2}{H_0 \sqrt{\Omega_{m0}}} \Big[ \sqrt{a + a_\text{eq}} - \sqrt{a_\text{eq}}\Big] && \Big(\Omega_k=\Omega_\Lambda=0\Big)
	\label{eq_conformal_time_anal}.
\end{align}
\label{eq_cosmic_conformal_time_anal}
\end{subequations}
In a universe with only radiation, these expressions reduce further to
\begin{align}
	t &= \frac{a^2}{2 H_0 \sqrt{\Omega_{r0}}}
	\qquad \text{and} \qquad
	\eta = \frac{a}{H_0 \sqrt{\Omega_{r0}}}
	&& \Big(\Omega_m=\Omega_k=\Omega_\Lambda=0\Big).
\label{eq_cosmic_conformal_time_anal_radiation}
\end{align}

To interpret these times physically, we glance back at the FLRW metric \eqref{eq_flrw}.
First, we see that cosmic time $t$ is the proper time of \emph{fundamental observers} that move with the expansion,
so a clock with zero peculiar velocity ticks at a rate corresponding to the cosmic time.
Second, we see that photons travel infinitesimal distances $c\,d\eta$ on the comoving grid (in $[\ldots]$),
so we can interpret the \textbf{(comoving) horizon}
\begin{equation}
D_\text{hor} = c \, \eta = c \int_0^\eta d\eta = c \int_0^t \frac{dt}{a(t)} = c \int_0^a \frac{da}{a^2 H} = c \int_0^x \frac{dx}{aH}
\label{eq_horizon}
\end{equation}
as the maximum (comoving) distance within which there can be causal communication.
This will be an essential quantity in later milestones.


\subsection{Implementation}
\label{sec_background_cosmology_implementation}

\begin{itemize}
	\item We represent a $\Lambda$CDM cosmology with an object that takes $h$, $\Omega_{b0}$, $\Omega_{c0}$, $\Omega_{k0}$, $T_{\gamma0}$ and $N_\text{eff}$ as free parameters,
	      and then computes the remaining dependent parameters from the relations \eqref{eq_planck2018}.
	\item We check whether a universe has a turnaround $\dot{a} = 0$ and our parametrization with $x$ breaks down.
	      This comes to use in \cref{sec_supernova}, where we allow for arbitrary curvature.
	\item We compute $\mathcal{H}(x)$ and its derivatives $\odv{\mathcal{H}}/{x}$ and $\odv[2]{\mathcal{H}}/{x}$ analytically based on the Friedmann equation \eqref{eq_friedmann}.
	      The derivatives can be derived without a lot of work by noting that
		  $E(x) = \Omega_{r0} e^{-4x} + \Omega_{m0} e^{-3x} + \Omega_{k0} e^{-2x} + \Omega_{\Lambda0}$
		  in the square root of the Hubble parameter has the derivatives
		  \begin{equation*}
			  \odv[d]{E}{x} = (-4)^d \Omega_{r0} a^{-4}(x) + (-3)^d \Omega_{m0} a^{-3}(x) + (-2)^d \Omega_{k0} a^{-2}(x) \qquad \big(d \geq 1\big).
		  \end{equation*}
	\item We compute the density parameters \eqref{eq_density_parameters} from today's density parameters using, for example for radiation, $\Omega_r = \rho_r / \rho_\text{crit} = (\rho_{r0} a^{-4} / \rho_{\text{crit},0}) (\rho_{\text{crit},0} / \rho_\text{crit}) = \Omega_{r0} a^{-4} (H_0 / H)^2$.
	\item We compute the radiation-matter and matter-cosmological constant equalities \eqref{eq_equality_times} analytically,
	      but the onset of the acceleration \eqref{eq_acceleration} numerically from when $\odv{\mathcal{H}}/{x} = \ddot{a} / H = 0$.
	\item We compute the cosmic time $t(x)$ and conformal time $\eta(x)$ by inserting their derivatives $\odv{t}/{x}$ and $\odv{\eta}/{x}$ into an adaptive 4th(5th)-order Runge-Kutta integrator.
	      As it is computationally infeasible to integrate from $x=-\infty$,
	      we start from a small initial value, like $x = -20$,
	      and the corresponding analytical cosmic or conformal time \eqref{eq_cosmic_conformal_time_anal} in a universe dominated by radiation and matter.
	\item We store the integrated $t(x)$ and $\eta(x)$ on a cubic spline, so subsequent evaluations are fast.
\end{itemize}

\subsection{Tests and results}

We create a cosmology with the Planck 2018 parameters \eqref{eq_planck2018} and study its evolution.

\begin{figure}[b!]
	\centering
	\includegraphics[scale=0.7]{../plots/density_parameters.pdf}
\caption{Evolution of the density parameters \eqref{eq_density_parameters} in the Planck 2018 cosmology \eqref{eq_planck2018}.}
\label{fig_density_parameters}
\end{figure}

\Cref{fig_density_parameters} shows that the universe
transitions from being dominated by radiation to matter to the cosmological constant,
with the equality times \eqref{eq_equality_times} reported in \cref{table_times1}.
In this cosmology, there is no curvature $\Omega_{k} = \Omega_{k0} = 0$,
and all density parameters sum to $\Omega_{r} + \Omega_m + \Omega_k + \Omega_\Lambda = 1$ at all times -- as they should, by the Friedmann equation \eqref{eq_friedmann} and definition \eqref{eq_density_parameters}.

\begin{figure}
	\centering
	\includegraphics[scale=0.7]{../plots/conformal_hubble.pdf}
	\includegraphics[scale=0.7]{../plots/conformal_hubble_derivative1.pdf}
	\includegraphics[scale=0.7]{../plots/conformal_hubble_derivative2.pdf}
	\caption{%
		Evolution of the conformal Hubble parameter \eqref{eq_conformal_hubble} and its two derivatives in the Planck 2018 cosmology \eqref{eq_planck2018},
		compared to their values from the analytical expression \eqref{eq_conformal_hubble_dominated} in dominated universes.
		Dashed lines show the equality times from \cref{fig_density_parameters},
		while the dotted line indicates the onset of the acceleration \eqref{eq_acceleration}.
	}
	\label{fig_conformal_hubble}
\end{figure}

\Cref{fig_conformal_hubble} shows the evolution of the conformal Hubble parameter \eqref{eq_conformal_hubble} and its two derivatives.
Note that the expansion rate $\dot{a}$ decreases most quickly during radiation domination and slower during matter domination,
but the universe starts to \emph{accelerate} slightly before $\Omega_m = \Omega_\Lambda$, at the time reported in \cref{table_times1}.
This is caused by the rise of the cosmological constant, and its effective negative pressure.
Moreover, during the three dominated eras,
the evolution is consistent with the analytical expectation \eqref{eq_conformal_hubble_dominated}.

\begin{figure}
	\centering
	\includegraphics[scale=0.7]{../plots/times.pdf}
	\caption{%
		Evolution of numerically integrated cosmic and conformal times \eqref{eq_cosmic_conformal_time} in the Planck 2018 cosmology \eqref{eq_planck2018},
		compared to the analytical expressions \eqref{eq_cosmic_conformal_time_anal} in a universe with no cosmological constant.
	}
	\label{fig_cosmic_conformal_time}

	\bigskip

	\includegraphics[scale=0.7]{../plots/eta_H.pdf}
	\caption{%
		Evolution of the product between the conformal time \eqref{eq_cosmic_conformal_time} and conformal Hubble parameter \eqref{eq_conformal_hubble},
		compared to that with the analytical time \eqref{eq_conformal_time_anal} and the Hubble parameter with $\Omega_{k0}=\Omega_{\Lambda0}=0$.
	}
	\label{fig_eta_H}
\end{figure}

\Cref{fig_cosmic_conformal_time} shows the relation between the scale factor and cosmic and conformal time \eqref{eq_cosmic_conformal_time} from numerical integration.
Before the cosmological constant becomes important, they closely match the analytical times \eqref{eq_cosmic_conformal_time_anal} from a universe with only radiation and matter.
We can also read off the current age of the universe, as reported in \cref{table_times1}.

\Cref{fig_eta_H} shows the evolution of the product $\eta \mathcal{H}$.
The former plots indicate that our computation of conformal time and the Hubble parameter work independently,
and this shows that so does the combination.
Through radiation-domination and matter-domination,
it follows the value we expect from the analytical expression \eqref{eq_conformal_time_anal}
and the Hubble parameter with $\Omega_{k} = \Omega_\Lambda = 0$.
In particular, as $x \rightarrow -\infty$ and radiation dominates,
the product between the conformal time \eqref{eq_cosmic_conformal_time_anal_radiation}
and the conformal Hubble parameter \eqref{eq_conformal_hubble_dominated_radiation} converges to 1.

\begin{table}
\centering
\caption{%
	The time of occurence of four important events in the evolution of a universe with the Planck cosmology \eqref{eq_planck2018},
	expressed in terms of the scale factor $a$, its natural logarithm $x = \log a$, redshift $z = \frac1a - 1$, cosmic time $t$ and conformal time $\eta$.
}
\label{table_times1}
\begin{tabular}{l c c c c c}
	\toprule
	Event                                                               & $x$     & $a$       & $z$    & $\eta$    & $t$ \\
	\midrule
	Radiation-matter equality ($\Omega_r = \Omega_m$)                   & $-8.13$ & $0.0003$  & $3400$ & $0.4\,\mathrm{Gyr}$ & $50\,\mathrm{kyr}$ \\
	Acceleration onset ($\ddot{a} = 0$)                                 & $-0.49$ & $0.61$    & $0.63$ & $38.5\,\mathrm{Gyr}$ & $7.8\,\mathrm{Gyr}$   \\
	Matter-cosmological constant equality ($\Omega_m = \Omega_\Lambda$) & $-0.26$ & $0.77$    & $0.29$ & $42.3\,\mathrm{Gyr}$ & $10.4\,\mathrm{Gyr}$  \\
	Today ($t = t_0$)                                                   & $0$     & $1$       & $0$    & $46.3\,\mathrm{Gyr}$ & $13.8\,\mathrm{Gyr}$  \\
	\bottomrule
\end{tabular}
\end{table}

\clearpage

\section{Cosmological constraints from supernovae}
\label{sec_supernova}

In this section, we forget most of the Planck cosmological parameters \eqref{eq_planck2018} for a moment;
neglecting neutrinos by fixing $N_\text{eff}=0$ and keeping only $T_{\gamma0}$, hence fixing $\Omega_{r0}$.
Instead, we constrain the independent parameters $h$, $\Omega_{m0}$ and $\Omega_{k0}$,
and hence the dependent $\Omega_{\Lambda 0}=1-\Omega_{k0}-\Omega_{m0}-\Omega_{r0}$,
using observed supernovae luminosity distances from \cite{betouleImprovedCosmologicalConstraints2014}.
To do so, we do a Markov chain Monte Carlo (MCMC) analysis
by stepping through cosmologies with various parameters using the Metropolis-Hastings algorithm
and comparing their predicted luminosity distances to the data.

\subsection{Theory}

\subsubsection{Cosmological distances}

From the FLRW metric \eqref{eq_flrw} and conformal time \eqref{eq_cosmic_conformal_time},
we can show how to compute distances in the universe.
Consider a photon traveling on a radial path with $d\theta = d\phi = 0$,
from emission at $(\eta,r)$ to our observation at $(\eta_0, 0)$,
along the null geodesic
\begin{equation*}
	0 = ds^2 = a^2(t) \left[ -c^2 d\eta^2 + \frac{dr^2}{1-kr^2} \right].
\end{equation*}
On the comoving grid (in $[\ldots]$), it travels the \textbf{comoving distance}
\begin{equation}
	\chi = \int_{\eta}^{\eta_0} c \, d\eta = c \, \big(\eta_0 - \eta\big) = \int_r^0 \frac{-dr}{\sqrt{1-kr^2}} = \frac{\asin\big(\sqrt{k}r\big)}{\sqrt{k}},
\label{eq_comoving_distance}
\end{equation}
so it came from the radial coordinate%
\footnote{This holds for all $k$ as $\sinc(x) = \sin x / x$ takes complex arguments, with $\sin(ix) = i \sinh x$ and $\sinc(0) = 1$.}
\begin{equation}
	r = \frac{\sin\Big(\sqrt{k}\chi\Big)}{\sqrt{k}} = \chi \sinc\Big(\sqrt{k}\chi\Big).
\label{eq_radial_coordinate}
\end{equation}

Given the observed redshift $z$ of light,
we can then compute its scale factor $a = (z+1)^{-1}$ at emission,
the corresponding conformal time \eqref{eq_cosmic_conformal_time},
the comoving distance \eqref{eq_comoving_distance}, the radial coordinate \eqref{eq_radial_coordinate}
and thus the corresponding \textbf{angular diameter distance} and \textbf{luminosity distance}
\begin{equation}
	d_A = a r
	\qquad \text{and} \qquad
	d_L = \frac{r}{a} = \frac{d_A}{a^2}.
\label{eq_distances}
\end{equation}

\subsubsection{Statistics}

From \cite{betouleImprovedCosmologicalConstraints2014},
we have measured luminosity distances $d_{L}^\text{obs}(z_i)$ and their
corresponding measurement uncertainties $\sigma_i^\text{obs}$
for $N=31$ different redshifts $z_i$.
Given the three cosmological parameters $h$, $\Omega_{m0}$ and $\Omega_{k0}$,
we can then fit the data to corresponding theoretically predicted distances $d_L(z_i; h, \Omega_{m0}, \Omega_{k0})$.
Assuming the different measurements are Gaussian distributed and uncorrelated,
the likelihood function that rates the fit is $L \propto e^{-\chi^2/2}$, where the $\chi^2$-function is
\begin{equation}
	\chi^2(h,\Omega_{m0},\Omega_{k0}) = \sum_{i=1}^{N} \left( \frac{d_L(z_i; h, \Omega_{m0}, \Omega_{k0}) - d_{L}^\text{obs}(z_i)}{\sigma_i^\text{obs}} \right)^2.
\label{eq_chi2}
\end{equation}

The Metropolis-Hastings algorithm steps through various combinations of $\mathbf{p} = (h,\Omega_{m0},\Omega_{k0})$ in parameter space, measuring their likelihood $L(\mathbf{p})$.
Each iteration $i$, it randomly shifts the parameters from their current values with a normal distribution,
and then records their new values as a random sample of their probability distribution with probability $\min\big\{L_{i+1}/L_i, 100\%\big\}$.

By the central limit theorem, once the algorithm has gathered many samples $\mathbf{p}_i$,
they should scatter around the \emph{best fit}
with maximum $L(\mathbf{p}_\text{best}) = \max\{L(\mathbf{p}_i)\}$
like a multivariate Gaussian with the same dimension $D$ as the parameter space.
We can then produce \emph{confidence regions} for the parameters
by identifying contours that enclose a given fraction $F$ of the samples.
For a multivariate Gaussian distribution, a fraction $F$ is enclosed by an ellipsoid
for which
\begin{equation}
	\chi^2_i - \chi^2_\text{best} < q_{\chi^2_D}(F),
\label{eq_confidence_region}
\end{equation}
where $q_{\chi^2_D}(F)$ is the inverse cumulative distribution function of the $\chi^2$-distribution with $D$ degrees of freedom.
We have $D=3$ independent parameters, and look for standard $68.3\%$ and $95.4\%$ confidence regions
with $q_{\chi^2_3}(68.3\%) \approx 3.53$ and $q_{\chi^2_3}(95.4\%) \approx 8.00$.

\subsection{Implementation}

\begin{itemize}
	\item We roll our own homemade Metropolis-Hastings algorithm.
	      It takes a function that computes the likelihood $L(\mathbf{p})$ for a set of parameters $\mathbf{p}$.
	      Unless specified explicitly, it sets step sizes of the parameters as a proportion of their lower and upper bounds,
		  and adaptively scales them if the algorithm accepts samples at a rate too far from the ``optimal'' acceptance rate around $25\%$ \cite{gelmanWeakConvergenceOptimal1997}.
		  The algorithm can run multiple chains from different initial parameter guesses,
		  each with a requested number of (accepted) samples after removing a given number of burn-in samples.
	\item We exclude parameters outside their specified bounds by assigning $L=0$ to them.
	\item As mentioned in \cref{sec_background_cosmology_theory},
	      our implementation of the background cosmology parametrized by the scale factor
	      \textbf{cannot handle cosmologies with turnaround} $\dot{a} = 0$.
	      These cosmologies can arise now that we allow $\Omega_{k0} \neq 0$,
	      for example with $\Omega_{r0}=0$, $\Omega_{m0} = 0.2$ and $\Omega_{k0} = -0.9$ and $\Omega_{\Lambda0} = 1.7$.
	      We identify such cosmologies as described in \cref{sec_background_cosmology_implementation}, and exclude them by setting $L=0$.
\end{itemize}

\subsection{Results}

\begin{figure}[!b]
	\centering
	\includegraphics[scale=0.7]{../plots/supernova_distance.pdf}
	\caption{Observed and predicted luminosity distances \eqref{eq_distances} from \cite{betouleImprovedCosmologicalConstraints2014} and the Planck cosmology \eqref{eq_planck2018}.}
	\label{fig_luminosity_distances}
\end{figure}

\Cref{fig_luminosity_distances} shows observed and predicted luminosity distances from the Planck 2018 cosmology \eqref{eq_planck2018}.
The prediction steers wide of most error bars, so the agreement is not very good!
This shows that supernovae are promising sources for generating orthogonal constraints on cosmological parameters complementary to the widely ``accepted'' Planck values, for example.
The plot also shows the much better agreement from the best fit parameters that we find next.

\begin{figure}[b]
	\centering
	\includegraphics[scale=0.7]{../plots/supernova_hubble.pdf}
	\includegraphics[scale=0.7]{../plots/supernova_omegas.pdf}
	\caption{%
		Probability distribution of today's reduced Hubble parameter $h$,
		and confidence regions \eqref{eq_confidence_region} for $\Omega_{m0}$ and $\Omega_{\Lambda0}$,
		from $10 \times 10000$ Metropolis-Hastings samples with $L \propto e^{-\chi^2/2}$ and the $\chi^2$ sum \eqref{eq_chi2},
		comparing predicted luminosity distances \eqref{eq_distances} to observations from \cite{betouleImprovedCosmologicalConstraints2014}.
		The algorithm restricts the parameters to the prior bounds $h \in [0.5, 1.5]$, $\Omega_{m0} \in [0, 1]$ and $\Omega_{k0} \in [-1, +1]$, and accordingly (with negligible radiation today) $\Omega_{\Lambda0} \in [-1, 2]$.
	}
	\label{fig_supernova_mcmc}
\end{figure}

\Cref{fig_supernova_mcmc} shows our MCMC constraints on $h$, $\Omega_{m0}$ and $\Omega_\Lambda$,
from the prior bounds $h \in [0.5, 1.5]$, $\Omega_{m0} \in [0, 1]$ and $\Omega_{k0} \in [-1, +1]$
that accommodate a wide region around the Planck values \eqref{eq_planck2018}, for example.
In addition, curved universes with a turnaround $\dot{a} = 0$ are forbidden
(\cite[Figure 11]{amanullahSpectraLightCurves2010} shows that such cosmologies are disconnected from the best fit regions, anyway).

Note that the constraint in the $\Omega_{m0}$-$\Omega_{\Lambda0}$-plane is highly orthogonal to the line of flat universes,
so supernova data can give good constraints when combined with some other argument in favor of flatness, for example.
Our best fits for $\Omega_{m0}$ and $\Omega_{\Lambda0}$ agrees relatively well with a similar analysis in \cite[Fig. 15]{betouleImprovedCosmologicalConstraints2014}.
Our Hubble parameter is significantly larger than Planck's and exemplifies the Hubble tension.

\clearpage
\section{Recombination and reionization history}

Photons (of the CMB) observed today were emitted at various times in the past.
In this section, our main goal is to accurately compute the optical depth and visibility function of the universe,
which play key roles in predicting today's observed CMB spectrum.
The most important process that affects this is Thomson scattering
\begin{equation}
	e^- + \gamma \leftrightarrow e^- + \gamma
\label{eq_thomson_scattering}
\end{equation}
of photons off free electrons as they travel through the universe.
To quantify the scattering, we must quantify the electrons,
and thus study the (re)combination and (re)ionization history of the universe.

\subsection{Theory}

Light emitted from a source with intensity $I_0$,
traveling through a medium with \textbf{optical depth} $\tau$ that scatters certain photons,
is observed at the other end with intensity $I = I_0 e^{-\tau}$.
As its name suggests, $\tau$ measures the ``thickness'' of the medium the light travels through:
a transparent medium through which most photons travels freely has $\tau \ll 1$,
while an opaque medium that scatters most photons has $\tau \gtrsim 1$.

In a cosmological context where the main mechanism is Thomson scattering \eqref{eq_thomson_scattering} with known cross-section $\sigma_T = (8\pi/3) (\alpha \hbar / m_e c)^2$,
we take the medium to be a gas of electrons with number density $n_e$.
In this case, the optical depth of photons emitted at conformal time $\eta$ and observed today at $\eta_0$ is
\begin{equation}
	\tau(\eta) = \int_\eta^{\eta_0} n_e \sigma_T a c \, d\eta = \int_x^0 \frac{n_e \sigma_T c}{H} \, dx.
\label{eq_optical_depth}
\end{equation}

A natural quantity derived from the optical depth is the \textbf{visibility function}%
\footnote{The normalization and interpretation of the visibility function also holds if it is defined with respect to the derivative of any other time, like $g(\eta) = -\tau'(\eta) e^{-\tau(\eta)}$.}
\begin{equation}
	\tilde{g}(x) = \Big( e^{-\tau(x)} \Big)' = -\tau'(x) \, e^{-\tau(x)}.
\label{eq_visibility_function}
\end{equation}
As $\tau=0$ today and $\tau \rightarrow \infty$ at early times,
it is normalized to $\int_{-\infty}^0 \tilde{g}(x) dx = e^0 - e^{-\infty}= 1$.
Moreover, if $e^{-\tau(x)} = I/I_0(x)$ measures how many ``input'' photons at $x$ that are ``output'' at $x=0$,
then its \emph{change} measures how many photons were lost between two times.
Accordingly, we interpret $\tilde{g}(x) dx$ as \emph{the probability that a photon observed today was last scattered between $x \pm dx/2$}.

We already know how all the quantities in the optical depth \eqref{eq_optical_depth} evolves, except the free electron density $n_e$.
Therefore, we set out to compute the free electron fraction $X_e(t) = n_e(t) / n_H(t)$,
where $n_H(t) \approx (1-Y_p) \rho_b(t) / m_\text{H}$ is the number density of hydrogen and
$Y_p$ and $1-Y_p$ are the primordial mass fractions of helium and hydrogen.
The free electron balance is mainly affected by
electrons combining with ionized H and He ($\rightarrow$)
and photons ionizing H and He $(\leftarrow$):
\begin{subequations}
\begin{align}
	e^- + \text{H}^+ &\leftrightarrow \text{H} + \gamma && \text{with ionization energy} & E_\text{H}^\text{ion} = 13.59844\,\mathrm{eV}, \\
	e^- + \text{He}^+ &\leftrightarrow \text{He} + \gamma && \text{with ionization energy} & E_\text{He}^\text{ion} = 24.58738\,\mathrm{eV}, \\
	e^- + \text{He}^{++} &\leftrightarrow \text{He}^+ + \gamma && \text{with ionization energy} & E_{\text{He}^+}^\text{ion} = 54.41776\,\mathrm{eV}.
\end{align}%
\label{eq_recombinations}%
\end{subequations}%
Before recombination, when these processes are in equilibrium and take place in an assumed charge neutral universe,
they give rise to the three \textbf{Saha equations}
\newcommand{\XHp}{X_{\text{H}^+}}
\newcommand{\XHep}{X_{\text{He}^+}}
\newcommand{\XHepp}{X_{\text{He}^{++}}}
\begin{subequations}
\begin{align}
    \frac{\XHp}{1-\XHp} &= \phantom{1} \, \frac{\lambda_e^{-3}}{n_e} \exp\left(-\frac{E^\text{ion}_\text{H}}{k_B T_b}\right) = R_1, \\
    \frac{\XHep}{1 - \XHep - \XHepp} &= 2 \, \frac{\lambda_e^{-3}}{n_e} \exp \left(-\frac{E^\text{ion}_\text{He}}{k_B T_b} \right) = R_2, \\
    \frac{\XHepp}{\XHep} &= 4 \, \frac{\lambda_e^{-3}}{n_e} \exp\left(-\frac{E^\text{ion}_{\text{He}^+}}{k_B T_b}\right) = R_3,
\end{align}%
\label{eq_saha_H_He}%
\end{subequations}%
for the ionization fractions $\XHp = n_{\text{H}^+} / n_\text{H}$, $\XHep = n_{\text{He}^+} / n_\text{He}$ and $\XHepp = n_{\text{He}^{++}} / n_\text{He}$,
where $n_\text{He} = Y_p \rho_b(t) / 4 m_\text{H}$ is the number density of helium and $\lambda_e = h / \sqrt{2 \pi m_e k_B T_b}$ is the de Broglie wavelength of electrons with baryon temperature $T_b$.
Assuming neutrality, the free electron fraction then follows as
\begin{equation}
    X_e = \frac{n_{\text{H}^+} + n_{\text{He}^+} + 2 n_{\text{He}^{++}}}{n_H} = \XHp +  \Big( \XHep + 2 \XHepp \Big) f_\text{He}, \quad \text{where} \quad f_\text{He} = \frac{n_\text{He}}{n_\text{H}} = \frac{Y_p}{4(1-Y_p)}.
\label{eq_Saha_H_He_Xe}
\end{equation}
In the early hot universe, the right sides $R_i \gg 1$ are very large, so $\{\XHp,\XHep,\XHepp\} \approx \{1,0,1\}$.
As the universe cools down, $\{R_3, R_2, R_1\}$ fall off one-by-one, in that order, due to differing ionization energies in the exponentials,
and $\text{He}^{++}$, $\text{He}^+$ and $\text{H}^+$ recombine with $e^-$ one-by-one.
%as the thermal energy reaches the decreasing ionization energies $k_B T_b \approx \{E^\text{ion}_\text{H}, E^\text{ion}_{\text{He}^+}, E^\text{ion}_{\text{He}^{++}}\}$.

Without helium ($Y_p=0$) or when it has fully recombined ($\XHp \gg \XHep \gg \XHepp$),
the equations reduces to the hydrogen-only \textbf{Saha equation}
\begin{equation}
	\frac{X_e^2}{1-X_e} = \frac{\lambda_e^{-3}}{n_b} \exp \left( -\frac{E^\text{ion}_\text{H}}{k_B T_b} \right).
\label{eq_saha_H}
\end{equation}

During and after recombination, when the reactions \eqref{eq_recombinations} are far from equilibrium,
the Saha equation is no longer valid,
and the evolution of $X_e$ is more accurately described by the \textbf{Peebles equation}
\TODO{is it only ``difficult to integrate'' (Callin) Peebles at early times, or is it \emph{wrong} there?}
\begin{equation}
	\odv{X_e}{x} = \frac{C_r}{H} \Big[ \beta (1-X_e) - n_H \alpha_2 X_e^2 \Big],
\label{eq_Peebles}
\end{equation}
with the many, but easy-to-compute quantities
%\begin{subequations}
\begin{align*}
	C_r &= \frac{\Lambda_{2s \rightarrow 1s} + \Lambda_\alpha}{\Lambda_{2s \rightarrow 1s} + \Lambda_\alpha + \beta_2}, &
	%\alpha &= \text{fine structure constant}, \\
	\alpha_2 &= \frac{64 \pi}{\sqrt{27 \pi}} \frac{\alpha^2 \hbar^2}{m_e^2 c} \sqrt{\frac{E^\text{ion}_\text{H}}{k_B T_b}} \phi_2, \\
	\beta &= \frac{\alpha_2}{\lambda_e^3} \exp \left(-\frac{E^\text{ion}_\text{H}}{k_B T_b}\right), &
	\beta_2 &= \beta \exp \left(\frac{3 E^\text{ion}_\text{H}}{4 k_B T_b}\right), \\
	\Lambda_{2s \rightarrow 1s} &= 8.227 / \mathrm{s}, &
	\Lambda_\alpha &= H \frac{(3 E^\text{ion}_{\text{H}})^3}{(\hbar c)^3 (8 \pi)^2 n_{1s}}, \\
	\phi_2 &= 0.448 \log \left( \frac{E^\text{ion}_\text{H}}{k_B T_b} \right), &
	n_{1s} &= (1-X_e) n_H.
\end{align*}
%\end{subequations}
As a differential equation, the Peebles equation needs an initial value.
This can be taken as the point $(x, X_e)$ of the Saha equation just after it departs from equilibrium, at $X_e = 0.999$, for example.

We also include a phenomenological model for \textbf{reionization}, due to radiation from stars formed at later times again kicking electrons out of neutral atoms.
In this model, we manually ramp up the free electron fraction according to the smoothed step functions
\TODO{$y$ or $z$ in last term?}
\begin{equation}
	X_e^\text{reion} = \frac{1+f_\text{He}}{2} \left[ 1 + \tanh \left( \frac{y^\text{reion}_1-y}{\Delta y^\text{reion}_1} \right) \right]
                     + \frac{f_\text{He}}{2} \left[ 1 + \tanh \left( \frac{y^\text{reion}_2-y}{\Delta y^\text{reion}_2} \right) \right]
\label{eq_reionization}
\end{equation}
where $y = (1+z)^{3/2}$, $\Delta y = |y'(z)| \Delta z$ and we have the four reionization parameters \eqref{eq_planck2018}.
Comparing with equation \eqref{eq_Saha_H_He_Xe}, we see this corresponds to reionizing $\text{H} \rightarrow \text{H}^+$ and $\text{He} \rightarrow \text{He}^+$ simultaneously \TODO{what motivates doing only these together?} first,
and later $\text{He}^{+} \rightarrow \text{He}^{++}$ separately.

Finally, then, the full free electron fraction is found by stitching together the results of the Saha and Peebles equation and adding reionization:
\begin{equation}
	X_e(x) = \begin{cases}
	             X_e^\text{reion}(x) + X_e^\text{Saha}(x) & \text{for $X_e^\text{Saha} > 0.999$}, \\
	             X_e^\text{reion}(x) + X_e^\text{Peebles}(x) & \text{for $X_e^\text{Saha} < 0.999$}. \\
	         \end{cases}
\label{eq_free_electron_fraction}
\end{equation}

We have not yet specified the evolution of the baryon temperature $T_b(t)$ that we need in the expressions above.
The photon temperature follows the simple black-body evolution
\begin{equation}
	T_\gamma(t) = \frac{T_{\gamma 0}}{a(t)}.
\label{eq_photon_temperature}
\end{equation}
Only at early times, when the photons and baryons are coupled, do they share the common temperature
\begin{equation}
	T_b(t) = T_{\gamma}(t).
\label{eq_baryon_temperature}
\end{equation}
After recombination and decoupling, however,
the baryon temperature generally evolves according to a differential equation that is coupled to the Peebles equation.
However, for our purposes of computing $X_e$,
it turns out that the error in assuming the common temperature \eqref{eq_baryon_temperature} is only of order $10^{-6}$ \cite[page 16]{keskitaloEffectMatterBaryon2005},
so we approximate $T_b \approx T_\gamma = T_{\gamma 0} / a$ \emph{all the time}.

Throughout the recombination history, we will refer to
\textbf{decoupling} as the time when the visibility function $g$ peaks,
and we say that the electrons and ions have \textbf{recombined} when the free electron fraction drops below $X_e = 0.1$.

The last quantity we introduce is the sound horizon
of the coupled photon-baryon plasma.
Before recombination, its sound speed is
$c_s(\eta) = c \sqrt{R(a) / 3(1+R(a))}$,
where $R(a) = 4 \Omega_{\gamma 0} / 3 \Omega_{b 0} a$,
so the \textbf{sound horizon} is
\begin{equation}
	s(\eta) = \int_0^\eta c_s(\eta) d\eta = \int_{-\infty}^x \frac{c_s \, dx}{\mathcal{H}}.
\label{eq_sound_horizon}
\end{equation}

\subsection{Implementation}

\begin{itemize}
\item
We solve the H-only Saha equation \eqref{eq_saha_H}
with right side $R$
as the quadratic equation $X_e^2 + R X_e - R = 0$.
Its positive solution is $X_e = (-R + \sqrt{R^2+4R})/2$,
but since $R$ can skyrocket and overflow,
we take the second-order Taylor expansion $X_e = (R/2) (1 - \sqrt{1 + 4/R}) \simeq 1 - 1/R$
when $R > 10^{10}$ that can only underflow, avoiding numerical issues.

\item
We solve the H+He Saha equation \eqref{eq_saha_H_He} with fixed-point iteration.
Starting with an initial guess $X_e^{(i)}$,
we analytically compute the corresponding $n_e = n_H X_e$,
then $\XHp$, $\XHep$ and $\XHepp$ from equation \eqref{eq_saha_H_He},
and finally a new free electron fraction $X_e^{(i+1)}$ from equation \eqref{eq_Saha_H_He_Xe};
repeating the process until $|X_e^{(i+1)}-X_e^{(i)}| < 10^{-15}$.
We choose the initial guess $X_e^{(0)}$ as the fast H-only solution from above,
resulting in fewer iterations compared to using a constant initial guess, like $X_e^{(0)} = 1$.
Note that while few iterations are needed around $X_e \approx 1$,
the convergence becomes extremely slow as $X_e \rightarrow 0$.
The Saha equation isn't valid in this regime anyway,
but we can still solve it accurately because most helium has already combined,
so $\XHepp \ll \XHep \ll \XHp$, and we simply the H-only solution when it is $X_e < 0.5$.

\item
We solve the Peebles equation with an ODE integrator and spline the result, like in \cref{sec_background_cosmology}.
As its initial condition, we give the time $x$ when $X_e^\text{Saha}(x) = 0.999$, found with a numerical root finder.
Note that the exponential in $\beta_2$ can overflow,
but substituting $\beta$ in $\beta_2$ yields a new exponential that can only underflow and is safe to compute.

\item
To compute the optical depth \eqref{eq_optical_depth} and the sound horizon \eqref{eq_sound_horizon},
we again use an ODE integrator and spline the result.
The former is integrated backwards from $\tau(\eta_0)=0$,
but the latter cannot start at $x_0 = -\infty$,
so we start it at the finite early time $x_0 = -20$ with $s(x_0) \approx c_s(x_0) / \mathcal{H}(x_0)$.

\item
We compute derivatives of splined quantities with spline-based methods,
but use analytical expressions for other quantities.
\end{itemize}

\subsection{Results}

Here we examine our results for the Planck 2018 cosmology \eqref{eq_planck2018},
with and without the reionization model \eqref{eq_reionization} and helium.
These parameters give the event times reported in \cref{table_times2}.

\begin{figure}[ht!]
	\centering
	\includegraphics[scale=0.7]{../plots/free_electron_fraction_log.pdf}
	\includegraphics[scale=0.7]{../plots/free_electron_fraction_linear.pdf}
	\caption{%
		Evolution of the free electron fraction \eqref{eq_free_electron_fraction},
		from the Saha and Peebles equations or Saha equation alone,
		with and without helium and reionization.
		The linear plot is annotated with the majority atom/ion at each recombination stage.
		The five vertical lines mark the times in \cref{table_times2}.
	}
	\label{fig_free_electron_fraction}
\end{figure}

\Cref{fig_free_electron_fraction} shows how the free electron fraction \eqref{eq_free_electron_fraction} evolves through recombination and reionization.
At early times, as we expected from the Saha equations \eqref{eq_saha_H_He},
we see that $X_e$ gradually steps down as the universe cools and the recombinations $\text{He}^{++} \rightarrow \text{He}^+ \rightarrow \text{He}$ and $\text{H}^+ \rightarrow \text{H}$ occur sequentially.
It flattens out at exactly the values we expect from equation \eqref{eq_Saha_H_He_Xe} with $\{\XHp, \XHep, \XHepp\}$ equal to $\{1,0,1\}$, $\{1,1,0\}$, $\{1,0,0\}$ and $\{0,0,0\}$.
We also see how the reionization model brings $X_e$ back up at late times;
first reionizing $\text{H} \rightarrow \text{H}^+$ and $\text{He} \rightarrow \text{He}^+$ together,
and later $\text{He}^{+} \rightarrow \text{He}^{++}$.
%$X_e$ gradually steps down from plateaus where $\{\XHp, \XHep, \XHepp\}$ (almost) changes
%from $\{1,0,1\}$ to $\{1,1,0\}$ to $\{1,0,0\}$ to $\{0,0,0\}$

Note that without reionization, the Peebles equation causes the free electron fraction to asymptotically freeze out today at the small values $X_e(0) = \{10^{-3.6}, 10^{-3.7}\}$ with and without helium.
If we took reionization of even more elements into account, the free electron fraction could freeze out at even (slightly) greater values.
In contrast, the Saha equation dives straight to $0$ during the final recombination to hydrogen.

Also note that under the hood of this plot, as described in the implementation details,
the code switches from the Saha to the Peebles equation when $X_e = 0.999$,
and the Saha-only prediction switches from the full H+He system \eqref{eq_saha_H_He} to the H-only equation \eqref{eq_saha_H} when $X_e = 0.5$.
The fact that the functions appear continuous and smooth at all these joints shows that the numerical implementation is robust.
It also agrees well with \cite[\textsc{fig. 1}]{callinHowCalculateCMB2006}.

\begin{figure}
	\centering
	\includegraphics[scale=0.7]{../plots/optical_depth.pdf}
	\caption{%
		Evolution of the optical depth \eqref{eq_optical_depth} and its derivatives through recombination and reionization history, with or without both helium and reionization.
		The five vertical lines mark the times in \cref{table_times2}.
	}
	\label{fig_optical_depth}
\end{figure}

\Cref{fig_optical_depth} shows the evolution of the optical depth \eqref{eq_optical_depth}.
As it measures the ``thickness'' of the medium that light emitted at various times $x$ has traveled through before reaching us today,
the plot is most sensible to interpret backwards in time (from right to left), and $\tau$ necessarily increases monotonically that way.
Without reionization, we see that the optical depth steadily increases to the still small value $\tau \approx 10^{-1}$ at $x \approx -7$, just after recombination.
With reionization, the same value is reached much quicker due to the ionized electrons, after which it flattens out.
For $x \approx -7$, the optical depth quickly ramps up to $\tau \approx 10^{2}$, as the electrons become free,
after which it continues to rise in the opaque early universe.

The three additional bumps in $\tau''(x)$ at $x \approx \{-9, -8, -1.5\}$ are caused by the smaller helium recombinations and reionizations.
Also note that $\tau'$ has an inflection point during the first reionization,
so $\tau''(x)$ is negative there and falls off the logarithmic plot.

The numerical implementation of $\tau(x)$ appears safe, as it uses the same ODE integrator that has been thoroughly tested with many earlier plots,
and the function appears well-resolved and smooth even during the recombinations and reionizations.
It also agrees well with \cite[\textsc{fig. 2}]{callinHowCalculateCMB2006}.

\begin{figure}[t]
	\centering
	\includegraphics[scale=0.7]{../plots/visibility_function_linear.pdf}
	\includegraphics[scale=0.7]{../plots/visibility_function_log.pdf}
	\caption{
		The visibility function \eqref{eq_visibility_function} and its (scaled) derivatives with or without both helium and reionization on a linear and logarithmic scale.
		Its numerical integrals are annotated.
		The five vertical lines mark the times in \cref{table_times2}.
	}
	\label{fig_visibility_function}
\end{figure}

\Cref{fig_visibility_function} shows the visibility function \eqref{eq_visibility_function},
which we interpreted as the probability density for the time that a photon observed today was last scattered.
There is very low visibility before recombination, as photons back then were continuously scattered in the coupled photon-baryon plasma.
During recombination and decoupling, the visibility spikes, as the decrease in free electrons clears the way for the first and largest ``wave'' of photons escaping to today.
This motivates naming the distance they have traveled the ``last scattering surface''.

Reionization gives rise to new free electrons, more scattering, and thus a more recent, but much smaller ``last scattering surface''.
The electrons are much more dilute at this point, so the visibility reaches only around $1/50$ of its peak value during decoupling.

As it is calculated analytically from the trusted optical depth, we have good reason to trust the visibility function's numerical implementation, too.
It behaves smoothly during recombination and reionization, again demonstrating that the integration tolerance for the optical depth is sufficient.
The plot also shows that it integrates numerically to $1$ with only tiny numerical errors, as we showed it should.
It also agrees well with \cite[\textsc{fig. 3}]{callinHowCalculateCMB2006}.

Finally, we calculate the sound horizon \eqref{eq_sound_horizon} at decoupling,
\begin{equation}
	s(x=-6.99) = 0.14\,\mathrm{Gpc}.
\end{equation}
For example, this agrees with the famous acoustic peak around $s \approx 105\,\mathrm{Mpc}/h$ in \cite[\textsc{Fig. 2}]{eisensteinDetectionBaryonAcoustic2005}.

\TODO{compare decoupling/recombination times with those reported from always using the Saha equation}

\begin{table}[b]
\centering
\caption{%
	The time of occurence of important events in the recombination and reionization history of a universe with the Planck cosmology \eqref{eq_planck2018},
	expressed in terms of the scale factor $a$, its natural logarithm $x = \log a$, redshift $z = \frac1a - 1$, cosmic time $t$ and conformal time $\eta$.
}
\label{table_times2}
\begin{tabular}{l c c c c c}
	\toprule
	Event                                                               & $x$     & $a$       & $z$    & $\eta$    & $t$ \\
	\midrule
	Switch from Saha to Peebles ($X_e^\text{Saha} = 0.999$) & $-7.43$ & $0.0006$  & $1685$ & $\phantom{0}0.7\,\mathrm{Gyr}$ & $0.18\,\mathrm{Myr}$ \\
	Decoupling ($\argmax(\tilde{g}(x)$)                     & $-6.99$ & $0.0009$  & $1084$ & $\phantom{0}0.9\,\mathrm{Gyr}$ & $0.38\,\mathrm{Myr}$ \\
	Recombination ($X_e = 0.1$)                             & $-6.97$ & $0.0009$  & $1063$ & $\phantom{0}0.9\,\mathrm{Gyr}$ & $0.39\,\mathrm{Myr}$ \\
	Hydrogen reionization ($z = z^\text{reion}_\text{H}$)   & $-2.20$ & $0.1111$  & $8$    & $16.4\,\mathrm{Gyr}$ & $0.64\,\mathrm{Gyr}$ \\
	Helium reionization ($z = z^\text{reion}_\text{H}$)     & $-1.50$ & $0.2222$  & $3.5$  & $23.5\,\mathrm{Gyr}$ & $1.80\,\mathrm{Gyr}$ \\
	\bottomrule
\end{tabular}
\end{table}



\clearpage
\section{Perturbations}

\newcommand\N{\mathcal{N}}
\newcommand\aH{\mathcal{H}}

\subsection{Theory}

Initial conditions
\begin{subequations}
\begin{align}
	\Psi &= -\frac{1}{\frac32 + \frac25 f_\nu}, \\
	\Phi &= -\left( 1 + \frac25 f_\nu \right) \Psi, \\
	\delta_c = \delta_b &= -\frac32 \Psi, \\
	v_c = v_b &= -\frac{ck}{2\mathcal{H}} \Psi, \\
	\Theta_0 &= -\frac12 \Psi, \\
	\Theta_1 &= +\frac{ck}{6\mathcal{H}} \Psi, \\
	\Theta_2 &= \begin{cases} -\frac{8}{15} \frac{ck}{\mathcal{H} \tau\prime} & \text{(polarization)}, \\ -\frac{20}{45} \frac{ck}{\mathcal{H} \tau\prime} & \text{(polarizatioff),} \end{cases} \\
	\Theta_{l \geq 3} &= -\frac{l}{2l+1} \frac{ck}{\mathcal{H} \tau\prime} \Theta_{l-1}, \\
	\Theta^P_0 &= \frac54 \Theta_2, \\
	\Theta^P_1 &= -\frac{ck}{4\mathcal{H}\tau\prime} \Theta_2, \\
	\Theta^P_2 &= \frac14 \Theta_2, \\
	\Theta^P_{l \geq 3} &= -\frac{l}{2l+1} \frac{ck}{\mathcal{H}\tau\prime} \Theta^P_{l-1}, \\
	\N_0 &= -\frac12 \Psi, \\
	\N_1 &= +\frac{ck}{6\mathcal{H}} \Psi, \\
	\N_2 &= -\frac{c^2 k^2 a^2}{12 H_0^2 \Omega_{\nu0}} (\Psi + \Phi) = \frac{c^2 k^2 a^2}{30 H_0^2 \Omega_{r0}} \Psi,\\
	\N_{l \geq 3} &= \frac{ck}{(2l+1)\mathcal{H}} \N_{l-1},
\end{align}
\label{eq_perturb_ic}
\end{subequations}

Full system
\begin{subequations}
\begin{align}
	{\Theta_l}^\prime   &= \begin{dcases}
	                       -\frac{ck}{\aH} \Theta_1 - \Phi^\prime & (l=0), \\
	                       \frac{ck}{3\aH} \bigg[ \Theta_0 - 2 \Theta_2 + \Psi \bigg] + \tau^\prime \bigg[ \Theta_1 + \frac{v_b}{3} \bigg] & (l=1), \\
	                       \frac{ck}{(2l+1)\aH} \bigg[ l \, \Theta_{l-1} - (l+1) \Theta_{l+1} \bigg] + \tau^\prime \bigg[ \Theta_l - \frac{\Pi}{10} \delta_{l,2} \bigg] & (l = 2, 3, \ldots, l_\text{max}-1), \\
	                       \frac{ck}{\aH} \Theta_{l-1} - \frac{l+1}{\aH \eta} \Theta_l + \tau^\prime \Theta_l & (l=l_\text{max}), \\
	                       \end{dcases} \\
	{\Theta^P_l}^\prime &= \begin{dcases}
	                       -\frac{ck}{\aH} \Theta^P_1 + \tau^\prime \bigg[ \Theta^P_0 - \frac{\Pi}{2} \bigg] & (l=0), \\
	                       \frac{ck}{(2l+1)\aH} \bigg[ l \, \Theta^P_{l-1} - (l+1) \Theta^P_{l+1} \bigg] + \tau^\prime \bigg[ \Theta^P_l - \frac{\Pi}{10} \delta_{l,2} \bigg] & (l = 1, 2, \ldots, l_\text{max}-1), \\
	                       \frac{ck}{\aH} \Theta^P_{l-1} - \frac{l+1}{\aH \eta} \Theta^P_l + \tau^\prime \Theta^P_l & (l=l_\text{max}), \\
	                       \end{dcases} \\
	{\N_l}^\prime       &= \begin{dcases}
	                       -\frac{ck}{\aH} \N_1 - \Phi^\prime & (l=0), \\
	                       \frac{ck}{3\aH} \bigg[ \N_0 - 2 \N_2 + \Psi \bigg] & (l=1) , \\
	                       \frac{ck}{(2l+1)\aH} \bigg[ l \, \N_{l-1} - (l+1) \N_{l+1} \bigg] & (l=2,3,\ldots,l_\text{max}-1), \\
	                       \frac{ck}{\aH} \N_{l-1} - \frac{l+1}{\aH \eta} \N_l & (l=l_\text{max}), \\
	                       \end{dcases} \\
	{\delta_c}^\prime   &= \frac{ck}{\aH} v_c - 3 \Phi^\prime , \\
	{\delta_b}^\prime   &= \frac{ck}{\aH} v_b - 3 \Phi^\prime , \\
	{v_c}^\prime        &= -v_c - \frac{ck}{\aH} \Psi , \\
	{v_b}^\prime        &= -v_b - \frac{ck}{\aH} \Psi + \tau^\prime R (3\Theta_1 + v_b), \\
	{\Phi}^\prime       &= \Psi - \frac{c^2 k^2}{3 \aH^2} \Phi + \frac{H_0^2}{2 \aH^2} \bigg[ \Omega_{c0} \delta_c a^{-1} + \Omega_{b0} \delta_b a^{-1} + 4 \Omega_{\gamma 0} \Theta_0 a^{-2} + 4 \Omega_{\nu 0} \N_0 a^{-2} \bigg] , \\
	{\Psi}^\prime       &= -\Phi - \frac{12 H_0^2}{c^2 k^2 a^2} \bigg[ \Omega_{\gamma 0} \Theta_2 + \Omega_{\nu 0} \N_2 \bigg] ,
\end{align}
\label{eq_perturb_full}
\end{subequations}

Tight coupling:
\begin{subequations}
\begin{align}
	\Theta_2   &= \begin{cases} -\frac{8}{15} \frac{ck}{\mathcal{H} \tau\prime} & \text{(polarization)}, \\ -\frac{20}{45} \frac{ck}{\mathcal{H} \tau\prime} & \text{(polarizatioff),} \end{cases} \\
	\Theta_l   &= -\frac{l}{2l+1} \frac{ck}{\aH \tau^\prime} \Theta_{l-1}, \\
	\Theta^P_0 &= \frac54 \Theta_2 , \\
	\Theta^P_1 &= -\frac{ck}{4\aH \tau^\prime} \Theta_2 , \\
	\Theta^P_2 &= \frac14 \Theta_2 , \\
	\Theta^P_l &= -\frac{l}{2l+1} \frac{ck}{\mathcal{H} \tau\prime} \Theta_{l-1}, \\
	q &= - \frac{\Big[\big(1-R\big)\tau^\prime+\big(1+R\big)\tau^{\prime\prime}\Big] \Big[ 3\Theta_1+v_b \Big] + \frac{ck}{\aH} \Big[ \Psi + \big(1-\frac{\aH^\prime}{\aH}\big)\big(\Theta_0-2\Theta_2\big) + \big(\Theta_0^\prime - 2 \Theta_2^\prime\big) \Big]}{\big(1+R\big)\tau^\prime + \frac{\aH^\prime}{\aH}-1}, \\
	v_b^\prime &= \frac{1}{1+R} \bigg[ -v_b - \frac{ck}{\aH} \Psi + R \Big( q - \frac{ck}{\aH} \big(\Psi + \Theta_0 - 2 \Theta_2 \big) \Big) \bigg], \\
	\Theta_1^\prime &= \frac{q - v_b^\prime}{3},
\end{align}
\label{eq_perturb_tight}
\end{subequations}

\subsection{Implementation}

\begin{itemize}
\item
However messy,
both the full system \eqref{eq_perturb_full} and the tight system \eqref{eq_perturb_tight} simply specify derivatives of (big) systems of differential equations
that can be integrated from the initial conditions \eqref{eq_perturb_ic} with Runge-Kutta methods.
We do this both with and without the tight coupling approximation.

\item
There is only one ambiguous/non-obvious calculation in the tight system:
$\Theta_1^\prime$ depends on $\Theta_2^\prime$ (through $q$),
but $\Theta_2$ depends on $\Theta_1$,
so $\Theta_2^\prime$ also depends on $\Theta_1^\prime$, making the calculation ``circular''.
We resolve this with fixed-point iteration.
This converges with a very small $\Theta_2^\prime$ in very few steps, so it is also a good approximation to simply neglect $\Theta_2^\prime$ in $q$.

\item
With the tight coupling approximation,
we integrate the tight system from the initial conditions while
$|1/\tau^\prime| < 0.1 \ll 1$,
$|ck/\aH\tau^\prime| < 0.1 \ll 1$ (both assumed in tight coupling),
$X_e > 0.999$ (before recombination really sets in)
or $x = -10$ (to avoid a kink in a polarization $\Theta^P$, as determined by trial and error).
Then we switch to integrating the full system, using the tight system's last values as its initial conditions, and finally combine and spline the results.
We integrate both regimes with the explicit \texttt{Vern9} method with absolute and relative error tolerance $10^{-9}$.
\textbf{This is inefficient}, as the integration chickens out and takes extremely small steps during the rapid oscillations following recombination.

\item
Without the tight coupling approximation,
we \textit{always} integrate the full system from the initial conditions using the \textbf{e}xplicit \textbf{s}ingly \textbf{d}iagonal \textbf{i}mplicit \textbf{R}unge-\textbf{K}utta method (ESDIRK) \texttt{KenCarp4} method, also with error tolerance $10^{-9}$.
This method is recommended for solving stiff problems with medium error tolerances \TODO{cite?},
and also used by \texttt{Bolt.jl}.
The \texttt{radau} algorithm also works well, but is not quite as fast.
This is the most natural, elegant and our preferred method for integrating the perturbation equations,
and we will see in our comparison below that we can \textbf{simply forget about the tight coupling approximation}.

\item
In addition to a function that integrates the perturbations over $x$ for a fixed mode $k$ and splines over $x$,
we implement a function that does so for multiple $k$ and splines over \emph{both} $x$ and $k$.
This will come in use later, when we need to evaluate the perturbations for many $k$.
Here we use a grid with 200 $k$-values in $0.0005 / \textrm{Mpc} \leq k \leq 0.3 / \textrm{Mpc}$, spaced quadratically with finer resolution for the larger-scale modes.
We take the $x$-values from the perturbation mode that requires the most integration points (instead of using different $x$ for each $k$, which is not supported by the spline library we use).

\item
On an expensive modern laptop,
integrating and splining the smallest-scale $k=0.3/\textrm{Mpc}$ perturbation mode
takes around $85 \textrm{ ms}$ with $1614$ $x$-values with our preferred \texttt{KenCarp4} method on only the full system.
In contrast, integrating the tight and full systems with an explicit method takes up to one second and uses $10000$s of steps.
With our preferred method, the $(x,k)$-splining process takes around (with $200$ $k$-values and 1625 $x$-values) takes around $16 \textrm{ s}$.

\item
We add compile-time flags for polarization and neutrinos,
forcing $\Theta^P_l = {\Theta^P_l}^\prime = \N_l = \N_l^\prime = 0$ when they are disabled.
\end{itemize}

\subsection{Results}

\begin{figure}[b]
\begin{minipage}{0.49\textwidth}
\includegraphics[height=5cm,right]{../plots/Thetal0.pdf} \\
\includegraphics[height=5cm,right]{../plots/Thetal1.pdf} \\
\includegraphics[height=5cm,right]{../plots/Thetal2.pdf} \\
\includegraphics[height=5cm,right]{../plots/ThetaPl0.pdf} \\
\end{minipage}
\hfill
\begin{minipage}{0.49\textwidth}
\includegraphics[height=5cm,right]{../plots/ThetaPl1.pdf} \\
\includegraphics[height=5cm,right]{../plots/ThetaPl2.pdf} \\
\includegraphics[height=5cm,right]{../plots/Nl0.pdf} \\
\includegraphics[height=5cm,right]{../plots/Nl1.pdf} \\
\end{minipage}
\caption{(continued on next page).}
\end{figure}%
\begin{figure}[ht!]
\ContinuedFloat
\begin{minipage}{0.49\textwidth}
\includegraphics[height=5cm,right]{../plots/Nl2.pdf} \\
\includegraphics[height=5cm,right]{../plots/velocity1.pdf} \\
\includegraphics[height=5cm,right]{../plots/velocity2.pdf} \\
\end{minipage}
\hfill
\begin{minipage}{0.49\textwidth}
\includegraphics[height=5cm,right]{../plots/potentials.pdf} \\
\includegraphics[height=5cm,right]{../plots/overdensity1.pdf} \\
\includegraphics[height=5cm,right]{../plots/overdensity2.pdf} \\
\end{minipage}
\caption{%
	Three different perturbation $k$-modes for the Planck cosmology \eqref{eq_planck2018} and $l_\text{max}=10$.
	Zoom in to see that \textit{each curve consists of three overlapping sub-curves}:
	the innermost integrates the full system with the \texttt{KenCarp4} method and interpolates across $x$;
	the middle integrates the tight and full system with the \texttt{Vern9} method and interpolates across $x$; and
	the outermost is identical to the innermost, but interpolates across both $x$ and $k$ after solving the system for $200$ quadratically spaced $k$-values.
	All integrators use the absolute and relative error tolerance $10^{-9}$.
	This is the reason for the ``blurry'' curves.
}
\end{figure}

\TODO{check that oscillations of most rapidly oscillating quantity are captured}

\clearpage
\section{Conclusions}

\TODO{use article template?}

%\bibliography{report.bib}
\printbibliography

\end{document}
